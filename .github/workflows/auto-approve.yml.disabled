# Auto-Approve Workflow (Use com CAUTELA!)
#
# âš ï¸ AVISO DE SEGURANÃ‡A:
# Auto-approve Ã© perigoso e deve ser usado APENAS para:
# - Dependabot PRs (atualizaÃ§Ãµes de dependÃªncias)
# - PRs de bots confiÃ¡veis
# - Ambientes de desenvolvimento/teste
#
# NUNCA use em produÃ§Ã£o sem revisÃ£o humana adicional!

name: Auto Approve (Conditional)

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    # âœ… CondiÃ§Ãµes rigorosas para aprovar automaticamente
    if: |
      github.actor == 'dependabot[bot]' ||
      (
        github.actor == 'github-actions[bot]' &&
        contains(github.event.pull_request.title, '[AUTO]')
      )
    
    steps:
      - name: Check PR conditions
        id: check
        run: |
          echo "Checking if PR meets auto-approve criteria..."
          
          # Verificar se PR Ã© pequena (menos de 100 linhas)
          ADDITIONS=${{ github.event.pull_request.additions }}
          DELETIONS=${{ github.event.pull_request.deletions }}
          TOTAL=$((ADDITIONS + DELETIONS))
          
          if [ $TOTAL -gt 100 ]; then
            echo "should_approve=false" >> $GITHUB_OUTPUT
            echo "âŒ PR too large for auto-approve ($TOTAL lines)"
            exit 0
          fi
          
          echo "should_approve=true" >> $GITHUB_OUTPUT
          echo "âœ… PR meets auto-approve criteria"

      - name: Auto Approve PR
        if: steps.check.outputs.should_approve == 'true'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: |
            ðŸ¤– **Auto-approved** por workflow automatizado.
            
            **CritÃ©rios atendidos:**
            - âœ… Autor confiÃ¡vel ({{ github.actor }})
            - âœ… Tamanho pequeno (< 100 linhas)
            - âœ… Testes passando
            
            âš ï¸ **Nota:** RevisÃ£o humana ainda recomendada para questÃµes de design e arquitetura.

      - name: Comment on PR
        if: steps.check.outputs.should_approve == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **Auto-approve bloqueado**: PR nÃ£o atende critÃ©rios (muito grande ou autor nÃ£o autorizado). RevisÃ£o humana necessÃ¡ria.'
            })
