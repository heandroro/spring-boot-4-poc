#!/usr/bin/env bash
set -euo pipefail

# Optional guard: only run when explicitly enabled
if [[ -z "${RUN_SONAR_PRECOMMIT:-}" ]]; then
  echo "[pre-commit] RUN_SONAR_PRECOMMIT not set; skipping SonarQube analysis."
  exit 0
fi

if [[ -z "${SONAR_TOKEN:-}" ]]; then
  echo "[pre-commit] SONAR_TOKEN is required to run SonarQube analysis." >&2
  exit 1
fi

SONAR_URL="${SONAR_URL:-http://localhost:9000}"
status=$(curl -sf "${SONAR_URL}/api/system/status" 2>/dev/null || true)
if [[ "${status}" != *"UP"* ]]; then
  echo "[pre-commit] SonarQube is not UP at ${SONAR_URL}. Start it with 'docker compose up -d sonarqube'." >&2
  exit 1
fi

# Run tests, coverage, and SonarQube analysis
./gradlew test jacocoTestReport sonarqube
